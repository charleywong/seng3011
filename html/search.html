<!DOCTYPE html>
<html>
<head>
    <link rel = "stylesheet" type="text/css" href="custom.css">
    <title>Page Title</title>
</head>

<script src="./js/Chart.min.js"></script>
<script src="./js/hammer.min.js"></script>
<script src="./js/chartjs-plugin-zoom.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js"></script>
<script>
function createChartData(label, dataPoints, colour) {
  return {
    label: label,
    fill: false,
    lineTension: 0.1,
    backgroundColor: "rgba("+colour.toString()+")",
    borderColor: "rgba("+colour.toString()+")",
    borderCapStyle: 'butt',
    borderDash: [],
    borderDashOffset: 0.0,
    borderJoinStyle: 'miter',
    pointBorderColor: "rgba(75,192,192,1)",
    pointBackgroundColor: "#fff",
    pointBorderWidth: 1,
    pointHoverRadius: 5,
    pointHoverBackgroundColor: "rgba(75,192,192,1)",
    pointHoverBorderColor: "rgba(220,220,220,1)",
    pointHoverBorderWidth: 2,
    pointRadius: 1,
    pointHitRadius: 10,
    data: dataPoints,
    spanGaps: false,
  }
}

$(document).ready(function(){
    $("#submitRequest").click(function(event){
      event.preventDefault();
      var parts = $("#date").val().split('-');
      var year = parts[0];
      var month = parts[1];
      var day = parts[2];
      var fixedDateFormat = month+"/"+day+"/"+year;

      //add date
      var formData = $('#searchForm').serializeArray();
      formData.push({name:"DateOfInterest", value:fixedDateFormat});
      // serialize data
      formData = $.param(formData);

      var API_ENDPOINT = '/api/company_returns';

      // ajax call to get result
      $.get(API_ENDPOINT, formData, function(result, status){
        // check for error
        // if exists result.Error

        var chartCMRDataSets = [];
        var chartAVRDataSets = [];
        var chartRTDataSets = [];
        var chartXLabels = [];
        var chartData = [];
        var tableData = [];

        // get x axis labels
        for (var i=0; i < result.CompanyReturns[0].Data.length; i++) {
          chartXLabels.push(result.CompanyReturns[0].Data[i].Date);
        }

        //populate tableData column names (create a row with those names)
        var headRow = ["Instrument ID", "Date", "Return"];
        if (result.CompanyReturns[0].Data[0].hasOwnProperty("CM_Return")) {
          headRow.push("Cumulative Returns");
        }
        if (result.CompanyReturns[0].Data[0].hasOwnProperty("AV_Return")) {
          headRow.push("Average Returns");
        }
        tableData.push(headRow);


        for (var i=0; i < result.CompanyReturns.length; i++) {
          var instrumentID = result.CompanyReturns[i].InstrumentID;
          var instrData = result.CompanyReturns[i].Data;

          //random color
          var clrRNG = new Math.seedrandom(instrumentID);
          var clrR = Math.floor(clrRNG.quick() * 155)+100;
          var clrG = Math.floor(clrRNG.quick() * 155)+100;
          var clrB = Math.floor(clrRNG.quick() * 155)+100;
          var colourCM = [clrR,clrG,clrB,255];
          var colourAV = [Math.floor(clrR*0.7),Math.floor(clrG*0.7),Math.floor(clrB*0.7),255];
          var colourRT = [Math.floor(clrR*0.5),Math.floor(clrG*0.5),Math.floor(clrB*0.5),255];

          var chartCMRData = [];
          var chartAVRData = [];
          var chartRTData = [];

          //loop through data
          for (var j=0; j < instrData.length; j++) {
            var rowData = [instrumentID];
            var thisData = instrData[j];

            rowData.push(thisData.Date);
            rowData.push(thisData.Return);
            chartRTData.push(thisData.Return);

            if (thisData.hasOwnProperty("CM_Return")) {
              var cmret = thisData.CM_Return;

              if (cmret != null) {
                console.log("CMR: "+ cmret.toString());
                chartCMRData.push(cmret);
                rowData.push(cmret);
              } else {
                chartCMRData.push(0);
                rowData.push(0);
              }
            }
            if (thisData.hasOwnProperty("AV_Return")) {
              var avret = thisData.AV_Return;

              if (avret != null) {
                console.log("AVR: "+ avret.toString());
                chartAVRData.push(avret);
                rowData.push(avret);
              }else {
                chartAVRData.push(0);
                rowData.push(0);
              }
            }
            //console.log("--------------");

            tableData.push(rowData);
          }

          chartCMRDataSets.push([instrumentID + ": CMR", chartCMRData, colourCM]);
          chartAVRDataSets.push([instrumentID + ": AVR", chartAVRData, colourAV]);
          chartRTDataSets.push([instrumentID + ": RT", chartRTData, colourRT]);

        }
        //chartDataSets.push({"instrumentID": "APPL"});
        //console.log(JSON.stringify(chartDataSets));

        //populate table
        var html = '';
        for(var i = 0; i < tableData.length; i++) {
          html += '<tr>';
          for (var j=0; j < tableData[i].length; j++) {
            html += '<td>' + tableData[i][j] + '</td>';
          }
          html += '</tr>';
        }
        $('#resultTable').html(html);

        // format json to pass to chart.js

        for (var i = 0; i < chartCMRDataSets.length; i++) {
          chartData.push(createChartData(chartCMRDataSets[i][0], chartCMRDataSets[i][1], chartCMRDataSets[i][2]));
        }
        for (var i = 0; i < chartAVRDataSets.length; i++) {
          chartData.push(createChartData(chartAVRDataSets[i][0], chartAVRDataSets[i][1], chartAVRDataSets[i][2]));
        }
        for (var i = 0; i < chartRTDataSets.length; i++) {
          chartData.push(createChartData(chartRTDataSets[i][0], chartRTDataSets[i][1], chartRTDataSets[i][2]));
        }

        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
          var data = new google.visualization.DataTable();

          //chart
          data.addColumn("string", "Date");

          var gglChartData = [];

          console.log(JSON.stringify(result));

          for (var i=0; i < result.CompanyReturns.length; i++) {
            // add required columns
            var companyData = result.CompanyReturns[i].Data;
            var instrumentID = result.CompanyReturns[i].InstrumentID;
            console.log(instrumentID);


            //push required columns
            data.addColumn("number", instrumentID+" Rtrn");
            if (companyData[0].hasOwnProperty("CM_Return")) {
              data.addColumn("number", instrumentID+" CMRtrn");
            }
            if (companyData[0].hasOwnProperty("AV_Return")) {
              data.addColumn("number", instrumentID+" AVRtrn");
            }

            var rowgglData = [];
            for (var j=0; j < companyData.length; j++) {
              if (j >= gglChartData.length) {
                gglChartData.push([companyData[j].Date]);
              }

              gglChartData[j].push(companyData[j].Return);
                if (companyData[j].hasOwnProperty("CM_Return")) {
                  gglChartData[j].push(companyData[j].CM_Return);
                }
                if (companyData[j].hasOwnProperty("AV_Return")) {
                  gglChartData[j].push(companyData[j].AV_Return);
                }
              }
            }

          data.addRows(gglChartData);

          var options = {
            title: 'Company Performance',
            curveType: 'function',
            legend: { position: 'bottom' },
            explorer: {maxZoomIn: 0.01, keepInBounds: true}
          };

          var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

          chart.draw(data, options);
        };


        var ctx = document.getElementById("chartCanvas");//.getContext("2d");
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartXLabels,
              datasets: chartData
            },
            options: {
                responsive: false,
                scales: {
                  xAxes: [{
                    display: true,
                    scaleLabel: {
                        labelString: 'Date',
                        display: true,
                      },
                  }],
                  yAxes: [{
                    display: true,
                    scaleLabel: {
                      labelString: 'Value',
                      display: true
                    }
                  }]
                },
                pan: {
                    enabled: true,
                    mode: 'xy'
                },
                zoom: {
                    enabled: true,
                    mode: 'xy',
                }
              }
            });
      })
    });
});
</script>


<body>
  <h1>Heading</h1>
  <p>This is paragraph.</p>
  <form id="searchForm"><!-- action="/api/company_returns"-->
    Company Code(s):
    <input type="text" name="InstrumentID" value="ABP.AX"> </br><!--need ajax here to help show possible results while typing-->
    Upper Window:
    <input type="text" name="UpperWindow" value="5"> </br>
    Lower Window:
    <input type="text" name="LowerWindow" value="3"> </br>

    Results for this date period:</br>
    <input type="checkbox" name="ListOfVar" value="CM_Return"> Cumulative Returns</br>
    <input type="checkbox" name="ListOfVar" value="AV_Return"> Average Returns</br>
  </form>

  date of interest:
  <input type="date" id="date" name="DateOfInterest" value="2012-10-12"> </br>
  <button id="submitRequest">Get Results</button>

  <div id="result">
    <table id="resultTable">
    </table>
    <canvas id="chartCanvas" width='400' height='400' style="max-width: 600px;max-height: 400px;"></canvas>

    <div id="curve_chart" style="width: 900px; height: 500px"></div>
  </div>

  <p>(CMR = Cumulative Returns, AVR = Average Returns)</p>
</body>

</html>
