<!DOCTYPE html>
<html>
<head>
    <link rel = "stylesheet" type="text/css" href="custom.css">
    <title>Page Title</title>
</head>


<script src="./Chart.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js"></script>
<script>
function createChartData(label, dataPoints, colour) {
  return {
    label: label,
    fill: false,
    lineTension: 0.1,
    backgroundColor: "rgba("+colour.toString()+")",
    borderColor: "rgba("+colour.toString()+")",
    borderCapStyle: 'butt',
    borderDash: [],
    borderDashOffset: 0.0,
    borderJoinStyle: 'miter',
    pointBorderColor: "rgba(75,192,192,1)",
    pointBackgroundColor: "#fff",
    pointBorderWidth: 1,
    pointHoverRadius: 5,
    pointHoverBackgroundColor: "rgba(75,192,192,1)",
    pointHoverBorderColor: "rgba(220,220,220,1)",
    pointHoverBorderWidth: 2,
    pointRadius: 1,
    pointHitRadius: 10,
    data: dataPoints,
    spanGaps: false,
  }
}

$(document).ready(function(){
    $("#submitRequest").click(function(event){
      event.preventDefault();
      console.log($("#date").val());
      var parts = $("#date").val().split('-');
      var year = parts[0];
      var month = parts[1];
      var day = parts[2];
      var fixedDateFormat = month+"/"+day+"/"+year;

      console.log(fixedDateFormat);

      //add date
      var formData = $('#searchForm').serializeArray();
      formData.push({name:"DateOfInterest", value:fixedDateFormat});
      // serialize data
      formData = $.param(formData);

      var API_ENDPOINT = '/api/company_returns';
      console.log(formData);

      // ajax call to get result
      $.get(API_ENDPOINT, formData, function(result, status){
        // check for error
        // if exists result.Error

        var chartCMRDataSets = [];
        var chartAVRDataSets = [];
        var chartXLabels = [];
        var chartData = [];
        var tableData = [];

        // get x axis labels
        for (var i=0; i < result.CompanyReturns[0].Data.length; i++) {
          chartXLabels.push(result.CompanyReturns[0].Data[i].Date);
        }

        //populate tableData column names (create a row with those names)
        var headRow = ["Instrument ID", "Date", "Return"];
        if (result.CompanyReturns[0].Data[0].hasOwnProperty("CM_Return")) {
          headRow.push("Cumulative Returns");
        }
        if (result.CompanyReturns[0].Data[0].hasOwnProperty("AV_Return")) {
          headRow.push("Average Returns");
        }
        tableData.push(headRow);



        for (var i=0; i < result.CompanyReturns.length; i++) {
          var instrumentID = result.CompanyReturns[i].InstrumentID;
          var instrData = result.CompanyReturns[i].Data;

          //random color
          var clrRNG = new Math.seedrandom(instrumentID);
          var clrR = Math.floor(clrRNG.quick() * 155)+100;
          var clrG = Math.floor(clrRNG.quick() * 155)+100;
          var clrB = Math.floor(clrRNG.quick() * 155)+100;
          var colourCM = [clrR,clrG,clrB,255];
          var colourAV = [Math.floor(clrR*0.6),Math.floor(clrG*0.6),Math.floor(clrB*0.6),255];

          var chartCMRData = [];
          var chartAVRData = [];

          //loop through data
          for (var j=0; j < instrData.length; j++) {
            var rowData = [instrumentID];
            var thisData = instrData[j];

            rowData.push(thisData.Date);
            rowData.push(thisData.Return);

            if (thisData.hasOwnProperty("CM_Return")) {
              var cmret = thisData.CM_Return;
              if (cmret != null) {
                console.log("CMR: "+ cmret.toString());
                chartCMRData.push(cmret);
                rowData.push(cmret);
              } else {
                chartCMRData.push(0);
                rowData.push(0);
              }
            }
            if (thisData.hasOwnProperty("AV_Return")) {
              var avret = thisData.AV_Return;
              if (avret != null) {
                console.log("AVR: "+ avret.toString());
                chartAVRData.push(avret);
                rowData.push(avret);
              }else {
                chartAVRData.push(0);
                rowData.push(0);
              }
            }
            console.log("--------------");

            tableData.push(rowData);
          }
          console.log(colourCM.toString());
          console.log(colourAV.toString());
          chartCMRDataSets.push([instrumentID + ": CMR", chartCMRData, colourCM]);
          chartAVRDataSets.push([instrumentID + ": AVR", chartAVRData, colourAV]);

        }
        //chartDataSets.push({"instrumentID": "APPL"});
        //console.log(JSON.stringify(chartDataSets));

        //populate table
        var html = '';
        for(var i = 0; i < tableData.length; i++) {
          html += '<tr>';
          for (var j=0; j < tableData[i].length; j++) {
            html += '<td>' + tableData[i][j] + '</td>';
          }
          html += '</tr>';
        }
        $('#resultTable').html(html);

        // format json to pass to chart.js

        for (var i = 0; i < chartCMRDataSets.length; i++) {
          chartData.push(createChartData(chartCMRDataSets[i][0], chartCMRDataSets[i][1], chartCMRDataSets[i][2]));
        }
        for (var i = 0; i < chartAVRDataSets.length; i++) {
          chartData.push(createChartData(chartAVRDataSets[i][0], chartAVRDataSets[i][1], chartAVRDataSets[i][2]));
        }


        var ctx = document.getElementById("chartCanvas");
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: chartXLabels,
              datasets: chartData,
              options: {
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero:true
                    }
                  }]
                }
              }
            }
          }
        );

      })
    });
});
</script>


<body>
  <h1>Heading</h1>
  <p>This is paragraph.</p>
  <form id="searchForm"><!-- action="/api/company_returns"-->
    Company Code(s):
    <input type="text" name="InstrumentID" value="ABP.AX"> </br><!--need ajax here to help show possible results while typing-->
    Upper Window:
    <input type="text" name="UpperWindow" value="5"> </br>
    Lower Window:
    <input type="text" name="LowerWindow" value="3"> </br>

    Results for this date period:</br>
    <input type="checkbox" name="ListOfVar" value="CM_Return"> Cumulative Returns</br>
    <input type="checkbox" name="ListOfVar" value="AV_Return"> Average Returns</br>
    <input type="checkbox" name="ListOfVar" value="Daily_MinMax"> Daily Min and Max</br>
  </form>

  date of interest:
  <input type="date" id="date" name="DateOfInterest" value="2012-10-12"> </br>
  <button id="submitRequest">Get Results</button>

  <div id="result">
    <table id="resultTable">
    </table>
    <canvas id="chartCanvas"></canvas>
  </div>

  <p>(CMR = Cumulative Returns, AVR = Average Returns)</p>
</body>

</html>
